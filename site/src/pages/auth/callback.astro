---
import Base from '../../layouts/Base.astro';
---
<Base title="Signing in — NASA Archive">
  <div class="max-w-sm mx-auto py-16 text-center">
    <div class="text-[#CC4444] text-2xl mb-4">◆</div>
    <p class="text-[#888] text-sm" id="status">Signing you in...</p>
  </div>
</Base>

<script>
  import { supabase } from '../../lib/supabase';

  // Handle the OAuth/magic link callback
  supabase.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' && session) {
      // Redirect to where they came from, or homepage
      const next = new URLSearchParams(window.location.search).get('next') || '/';
      window.location.href = next;
    } else if (event === 'SIGNED_OUT') {
      window.location.href = '/login';
    }
  });

  // Also handle hash fragment from magic links
  const { data, error } = await supabase.auth.getSession();
  if (error) {
    document.getElementById('status')!.textContent = 'Sign in failed — ' + error.message;
  } else if (data.session) {
    const next = new URLSearchParams(window.location.search).get('next') || '/';
    window.location.href = next;
  }
</script>
